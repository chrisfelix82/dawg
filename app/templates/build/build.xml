<?xml version="1.0"?>

<project name="build" default="all" basedir="." >

	<!-- =========================================================================== -->
    <!-- Targets: clean                                                              -->                        
    <!-- =========================================================================== -->
    <target name="clean" depends="init">
        <echo message="Clearing release directory: ${dojoReleaseDir}" />
        <delete includeemptydirs="true" failonerror="false">
            <fileset dir="${dojoReleaseDir}" includes="**/*" excludes="**/.jazzignore" />
        </delete>
        <delete includeemptydirs="true" failonerror="false">
            <fileset dir="${worklightBuildOutputFolder}" includes="**/*" excludes="**/.jazzignore" />
        </delete>
    </target>

	<target name="init"> 
		<property name="worklightVersion"                 value="5.0.6" />
		<property name="worklightProjectName"             value="MobileProject" />
        <property name="worklightAppName"                 value="main" />
        <property name="worklightAppVersion"              value="1.0" />
        <property name="worklightEnvironments"            value="common,ipad" />
        <property name="worklightAdapters"                value="User" />
        <property name="buildEnvironment"                 value="prod" />
        <property name="worklightServer"                  value="http://i4i27.torolab.ibm.com:9090/worklight"/>
        <property name="appcenter_server" 				  value="http://i4i27.torolab.ibm.com:9090/" />
		<property name="appcenter_context" 				  value="applicationcenter" />
		<property name="appcenter_username" 			  value="appcenteradmin" />
		<property name="appcenter_password" 			  value="admin" />
        
        <property name="dojoSourceDir"                    value="${basedir}/../dojo" />
        <property name="dojoReleaseDir"                   value="${basedir}/release" />
        <property name="worklightDir"                     value="${basedir}/../apps/${worklightAppName}" />
        <property name="worklightBuildOutputFolder"       value="${basedir}/wl_build" />
        <property name="testAutomationJars"               value="${basedir}/../../TestAutomationJars" />
        <property name="testAutomationProject"            value="${basedir}/../../TestAutomation" />
        <property name="testAutomationDebugLevel"         value="source,lines,vars" />
		<property name="testAutomationSourceLevel"        value="1.6" />
		<property name="testAutomationTargetLevel"        value="1.6" />
		<property name="testHTTPServerRoot"				  value="/Library/WebServer/Documents"/>
		<property name="testAutomationJarPath"            value="/Users/chris/Documents/dev/RQM_Adapter/TestAutomationJars" />
		
		<property name="ios_env" 						  value="ipad" />
		<property name="ios_env_uppercase" 				  value="Ipad" />
		<property name="ios_projectName"  				  value="${worklightProjectName}${worklightAppName}${ios_env_uppercase}" />
		
         <property name="copyFiles"      value="
         dojo/dojo.js,
         dojox/mobile/deviceTheme.js
         " />
          <property name="copyDirs"      value="
         dojo/nls,
         dojo/cldr/nls
         
         " />
         
 		 <taskdef resource="net/sf/antcontrib/antlib.xml">
            <classpath>
                <pathelement location="${basedir}/ant-contrib-1.0b3.jar" />
            </classpath>
        </taskdef>
        
        <taskdef resource="com/worklight/ant/defaults.properties">
			<classpath>
				<pathelement location="${basedir}/worklight-ant-${worklightVersion}.jar" />
			</classpath>
		</taskdef>
		
	    <path id="server-classpath">
			<fileset dir="../server/lib">
				<include name="*.jar" />
			</fileset>
		</path>	
		
		<path id="testautomation-classpath">
			<fileset dir="${testAutomationJars}">
				<include name="**/*.jar" />
			</fileset>
		</path>
		
		<path id="classpath.run">
 			<fileset dir="${basedir}">
 			<include name="applicationcenterdeploytool.jar" />
 			<include name="json4j.jar"/>
 			</fileset>
 		</path>
 		
 		<taskdef name="uploadapps" classname="com.ibm.appcenter.ant.UploadApps"> 
			<classpath refid="classpath.run" />
		</taskdef>
        
	</target>
	
	<!-- =========================================================================== -->
    <!-- Targets: dojoBuild                                                          -->                        
    <!-- =========================================================================== -->
    <target name="buildDojo" depends="clean,init">
        <echo message="Running Dojo build: --profile '${basedir}/profile.js' --appConfigFile '${worklightDir}/common/commonapp/config.json'" />
		
        <exec dir="${dojoSourceDir}/util/buildscripts"
            executable="bash"
            osfamily="unix"
            failonerror="no">
            <arg line="build.sh --profile ${basedir}/profile.js --appConfigFile ${worklightDir}/common/commonapp/config.json" />
        </exec>
  
    </target>
    
    <!-- =========================================================================== -->
    <!-- Targets: copyFiles                               						  -->
    <!-- ===========================================================================  -->
    <target name="copyFiles" depends="buildDojo">
		
        <echo message="Copying built app directories to Worklight dir: ${worklightDir}" /> 
        <copy failonerror="false" file="${dojoReleaseDir}/idx/mobile/themes/oneui_ios/oneui_ios.css" toFile="${worklightDir}/common/idx/mobile/themes/oneui_ios/oneui_ios.css" />
        
        <for list="${worklightEnvironments}" param="env" trim="true">
            <sequential>
                 <echo message="Clearing unbuilt app directories from: ${worklightDir}" />
        		<delete includeemptydirs="true" failonerror="true">
            		<fileset dir="${worklightDir}/@{env}/@{env}app" includes="**/*" excludes="**/.jazzignore" />
        		</delete>
                <echo message="Copying built files for environment: @{env}" />
                <copy todir="${worklightDir}/@{env}/@{env}app">
                    <fileset dir="${dojoReleaseDir}/@{env}app">
                        <include name="**/nls/*View*.js"/>
                        <include name="**/*.json"/>
                        <include name="**/images/**"/>
                        <include name="**/*View.js"/>
                        <include name="**/*View.html"/>
                        <include name="**/*View.css"/>
                        <include name="**/*Template.js"/>
                        <include name="**/*Template.html"/>
                        <include name="**/*Template.css"/>
                        <include name="**/*app.css"/>
                        <include name="**/*app.js"/>
                        <exclude name="**/*.uncompressed.js"/>
                    </fileset>
                </copy>
              <if>
					<equals arg1="@{env}" arg2="ipad" />
				<then>
			    	<copy file="${dojoReleaseDir}/dojox/mobile/themes/iphone/ipad.css" toFile="${worklightDir}/ipad/dojox/mobile/themes/iphone/ipad.css" />
			    	<copy file="${dojoReleaseDir}/dojox/mobile/themes/iphone/iphone.css" toFile="${worklightDir}/ipad/dojox/mobile/themes/iphone/iphone.css" />
				</then>
				<else>
					<copy failonerror="no" file="${dojoReleaseDir}/dojox/mobile/themes/@{env}/@{env}.css" toFile="${worklightDir}/@{env}/dojox/mobile/themes/@{env}/@{env}.css" />
				</else>
				</if>
				
				<if>
					<equals arg1="${env}" arg2="android" />
				<then>
			    	<copy failonerror="false" file="${dojoReleaseDir}/idx/mobile/themes/oneui_android/oneui_android.css" toFile="${worklightDir}/android/idx/mobile/themes/oneui_android/oneui_android.css" />
				</then>
				</if>
				</sequential>
        </for>

        <echo message="Copying additional common directories to Worklight dir: ${worklightDir}" />
        <for list="${copyDirs}" param="dir" trim="true">
            <sequential>
                <echo message="Copying directory: @{dir}" />
                <copy todir="${worklightDir}/common/@{dir}">
                    <fileset dir="${dojoReleaseDir}/@{dir}">
                        <exclude name="**/*.uncompressed.js"/>
                    </fileset>
                </copy>
            </sequential>
        </for>
        
        <echo message="Copying additional common files to Worklight dir: ${worklightDir}" />
        <for list="${copyFiles}" param="file" trim="true">
            <sequential>
                <echo message="Copying file: @{file}" />
                <copy file="${dojoReleaseDir}/@{file}" toFile="${worklightDir}/common/@{file}" />
            </sequential>
        </for>
        
        <echo message="Performing environment specific file modifications" />
        <move file="${worklightDir}/common/${worklightAppName}.html" tofile="${worklightDir}/common/${worklightAppName}_original.html" />
        <move file="${worklightDir}/common/${worklightAppName}_prod.html" tofile="${worklightDir}/common/${worklightAppName}.html" />
        
        <move file="${worklightDir}/application-descriptor.xml" tofile="${worklightDir}/application-descriptor_dev.xml" />
        <move file="${worklightDir}/application-descriptor_${buildEnvironment}.xml" tofile="${worklightDir}/application-descriptor.xml" />
        <move file="${basedir}/../server/conf/worklight.properties" tofile="${basedir}/../server/conf/worklight_dev.properties" />
        <move file="${basedir}/../server/conf/worklight_${buildEnvironment}.properties" tofile="${basedir}/../server/conf/worklight.properties" />
        
        <echo message="Finished copying standard resources" />
    </target>
    
    <!-- =========================================================================== -->
    <!-- Targets: buildwlapp                              						  -->
    <!-- ===========================================================================  -->
    <target name="buildwlapp" depends="init">
      <echo message="Packaging workligt app ${worklightAppName} with app-builder ant task" />
      <for list="${worklightEnvironments}" param="env" trim="true">
            <sequential>
                 <app-builder environments="@{env}" nativeProjectPrefix="${worklightProjectName}" applicationFolder="${worklightDir}" outputFolder="${worklightBuildOutputFolder}">
	  			 </app-builder>
            </sequential>
      </for>
    </target>
    
    <!-- =========================================================================== -->
    <!-- Targets: deploywlapp                              						  -->
    <!-- ===========================================================================  -->
    <target name="deploywlapp" depends="init">
	    <echo message="Deploying ${worklightProjectName}:${worklightAppName} to worklight server ${worklightServer} using app-deployer ant task" />
		<for list="${worklightEnvironments}" param="env" trim="true">
            <sequential>
            	<if>
					<equals arg1="@{env}" arg2="common" />
				<then>
			    	<app-deployer deployable="${worklightBuildOutputFolder}/${worklightAppName}-@{env}.wlapp" worklightServerHost="${worklightServer}">
					</app-deployer>
				</then>
				<else>
					<app-deployer deployable="${worklightBuildOutputFolder}/${worklightAppName}-@{env}-${worklightAppVersion}.wlapp" worklightServerHost="${worklightServer}">
					</app-deployer>
				</else>
				</if>
            </sequential>
      	</for>
	</target>
	
	<!-- Target: buildAdapter -->
	<target name="buildAdapters" depends="init">
		<echo message="Build worklight adapter for project ${worklightProjectName}" />
		<for list="${worklightAdapters}" param="adapter" trim="true">
			<sequential>
				<adapter-builder folder="${basedir}/../adapters/@{adapter}" destinationFolder="${worklightBuildOutputFolder}">
				</adapter-builder>
			</sequential>
		</for>
	</target>

	<!-- Target: deployAdapter -->
	<target name="deployAdapters" depends="init">
		<echo message="Deploy worklight adapter for project ${worklightProjectName}" />
		<for list="${worklightAdapters}" param="adapter" trim="true">
			<sequential>
				<adapter-deployer deployable="${worklightBuildOutputFolder}/@{adapter}.adapter" worklightServerHost="${worklightServer}" />
			</sequential>
		</for>
	</target>
	
	<!-- Target: buildWAR -->
	<target name="buildWAR" depends="init">
		<echo message="Building worklight WAR for project ${worklightProjectName}" />
		<javac srcdir="../server/java" destdir="${worklightBuildOutputFolder}/classes" classpathref="server-classpath" verbose="true" />
		<war-builder projectfolder="${basedir}/../../${worklightProjectName}" destinationfolder="${worklightBuildOutputFolder}/wartemp" warfile="${worklightBuildOutputFolder}/${worklightProjectName}.war" classesfolder="${worklightBuildOutputFolder}/classes">
		</war-builder>
	</target>
	
	<!-- Build js-doc. Builds javascript API docs based on Dojo's js-doc-parse project.  This target should only be run on a build server that the dojo API
	viewer is deployed on.  The steps in the target assume pushing build output files to the local file system.  You could in theory change the local
	copy to a remote copy if API viewer is remote to the build server.
	 -->
	<target name="generateAPIDocs" depends="init">
	    <exec osfamily="unix" dir="${basedir}/../docs/js-doc-parse" executable="bash">
	    	<arg line="runme.sh" />
	    </exec>
	    <!-- Windows is broken.  Need to do more digging. -->
	    <exec osfamily="windows" dir="${basedir}/../docs/js-doc-parse" executable="cmd.exe">
	    	<arg line="/c parse.bat C:\\mobile-project-builds\\MobileProject\\dojo\\" />
	    </exec>
	    
	    <copy todir="${testHTTPServerRoot}">
    		<fileset dir="${basedir}/../docs/www"/>
  		</copy>
	</target>
	
	
	<target name="buildTests" depends="init">
		<delete dir="${testAutomationProject}/classes" />
		<mkdir dir="${testAutomationProject}/classes" />
		
		<copy includeemptydirs="false" todir="${testAutomationProject}/classes">
			<fileset dir="${testAutomationProject}/src" excludes="**/*.launch, **/*.java" />
		</copy>
		<copy includeemptydirs="false" todir="${testAutomationJarPath}">
			<fileset dir="${testAutomationJars}" excludes="**/*.launch, **/*.java" />
		</copy>
		
		<!-- Build test jar -->
		<javac debug="true" debuglevel="${testAutomationDebugLevel}" destdir="${testAutomationProject}/classes" source="${testAutomationSourceLevel}" target="${testAutomationTargetLevel}">
			<src path="${testAutomationProject}/src" />
			<classpath refid="testautomation-classpath" />
		</javac>
		<jar destfile="${testAutomationJarPath}/TestAutomation.jar">
			<fileset dir="${testAutomationProject}/classes" />
		</jar>
		
		<!-- Copy over custom packages to HTTP server for DOH testing -->
		<copy includeemptydirs="false" todir="${testAutomationProject}/classes">
			<fileset dir="${testAutomationProject}/src" excludes="**/*.launch, **/*.java" />
		</copy>
		
		<for list="${worklightEnvironments}" param="dir" trim="true">
            <sequential>
                <echo message="Copying package to http server: @{dir}app" />
                <copy todir="${testHTTPServerRoot}/dojo/@{dir}app">
                    <fileset dir="${worklightDir}/@{dir}/@{dir}app">
                        <exclude name="**/*.uncompressed.js"/>
                    </fileset>
                </copy>
            </sequential>
        </for>
	</target>
	
	<!-- Target: build iOS client (ipa) -->
	<target name="buildipa" depends="init">
		<delete includeemptydirs="true" failonerror="false">
            <fileset dir="${worklightDir}/${ios_env}/build" includes="**/*" excludes="**/.jazzignore" />
        </delete>
		<exec executable="bash">
			<arg value="${basedir}/ios.build.sh" />
			<!-- worklightDir = $1 -->
			<arg value="${worklightDir}" />
			<!-- ios_env = $2 -->
			<arg value="${ios_env}" />
			<!-- ios_projectname = $3 -->
			<arg value="${ios_projectName}" />
			<!-- ipa location = $4 -->
			<arg value="${worklightBuildOutputFolder}/${ios_projectName}" />
			<!-- wl_appname = $5-->
			<arg value="${worklightAppName}" />
		</exec>
	</target>
	
	<!-- Target: deploy iOS client (ipa) to application center -->
	<target name="deployipa" depends="init">
		
		<uploadapps serverPath="${appcenter_server}"
					context="${appcenter_context}"
					loginUser="${appcenter_username}"
					loginPass="${appcenter_password}"
					forceOverwrite="true"
					file="${worklightBuildOutputFolder}/${ios_projectName}.ipa">
		</uploadapps>
	</target>
	
    

	<!-- =========================================================================== -->
    <!-- Targets: all                                                                -->                        
    <!-- =========================================================================== -->
    <target name="all" depends="generateAPIDocs,buildipa,buildWAR,deploywlapp,buildAdapters,deployAdapters,buildTests" />
</project>